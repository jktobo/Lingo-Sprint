/*
======================================================
LINGO-SPRINT APP.JS (–ü–û–î –î–ò–ó–ê–ô–ù 2.JPG, –§–ò–ö–° 8)
======================================================
*/

document.addEventListener("DOMContentLoaded", () => {
    // === 1. –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ===
    let state = {
        token: localStorage.getItem("token") || null,
        userEmail: localStorage.getItem("userEmail") || null,
        currentView: 'dashboard',
        currentLessonId: null,
        levels: [],
        lessons: [],
        sentences: [],
        currentSentenceIndex: 0,
        isPremium: false, // –ó–∞–≥–ª—É—à–∫–∞, –ø–æ–∑–∂–µ –±—É–¥–µ–º –∑–∞–≥—Ä—É–∂–∞—Ç—å
    };

    // === 2. –≠–ª–µ–º–µ–Ω—Ç—ã DOM ===
    const dom = {
        // –í–∏–¥—ã (Views)
        views: {
            auth: document.getElementById("auth-view"),
            dashboard: document.getElementById("dashboard-view"),
            trainer: document.getElementById("trainer-view"),
            subscription: document.getElementById("subscription-view"),
        },

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è (–¥–∞–∂–µ –µ—Å–ª–∏ —Å–∫—Ä—ã—Ç–∞, –ø—É—Å—Ç—å –±—É–¥–µ—Ç)
        navItems: document.querySelectorAll(".nav-item"),
        
        // –ü—Ä–æ—Ñ–∏–ª—å
        userName: document.querySelector(".user-profile .user-name"),
        userAvatar: document.querySelector(".user-avatar img"),
        logoutButton: document.getElementById("logout-button"),

        // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
        authView: document.getElementById("auth-view"),
        dashboardView: document.getElementById("dashboard-view"),
        authFormLogin: document.getElementById("login-form"),
        authFormRegister: document.getElementById("register-form"),
        showRegisterBtn: document.getElementById("show-register"),
        showLoginBtn: document.getElementById("show-login"),
        header: document.querySelector(".top-header"),
        mainContent: document.querySelector(".content"),

        // –î—ç—à–±–æ—Ä–¥
        levelsContainer: document.getElementById("levels-container"),
        lessonsContainer: document.getElementById("lessons-container"),
        currentLevelTitle: document.getElementById("current-level-title"),
        lessonProgressText: document.getElementById("lesson-progress-text"),

        statLessonsCompleted: document.getElementById("stat-lessons-completed"),
        statStars: document.getElementById("stat-stars"),
        statTime: document.getElementById("stat-time"),
        statAccuracy: document.getElementById("stat-accuracy"),

        // –¢—Ä–µ–Ω–∞–∂–µ—Ä
        trainerCard: document.getElementById("card"),
        backToLessonsBtn: document.getElementById("back-to-lessons"),
        progressText: document.getElementById("progress-text"),
        progressBarInner: document.getElementById("progress-bar-inner"),
        playAudioBtn: document.getElementById("play-audio"),
        promptRu: document.getElementById("current-sentence-ru"),
        userAnswer: document.getElementById("user-answer"),
        feedback: document.getElementById("feedback"),
        aiExplanation: document.getElementById("ai-explanation"),
        checkAnswerBtn: document.getElementById("check-answer"),
        nextSentenceBtn: document.getElementById("next-sentence"),

        // –ú–æ–¥–∞–ª–∫–∞ Premium
        premiumModalOverlay: document.getElementById("premium-modal-overlay"),
        premiumModalCloseBtn: document.querySelector("#premium-modal-overlay .modal-close"),
        premiumModalBuyBtn: document.getElementById("modal-buy-premium"),
    };

    // === 3. API –§—É–Ω–∫—Ü–∏–∏ ===

    async function fetchProtected(url, options = {}) {
        if (!state.token) {
            console.error("–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞. –í—ã—Ö–æ–¥.");
            handleLogout();
            return undefined; 
        }

        const defaultHeaders = {
            'Authorization': `Bearer ${state.token}`,
            'Content-Type': 'application/json'
        };

        const config = { ...options, headers: { ...defaultHeaders, ...options.headers } };

        try {
            const response = await fetch(url, config);
            if (response.status === 401) {
                console.error("–¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω (401). –í—ã—Ö–æ–¥.");
                handleLogout();
                return undefined;
            }
            if (response.status === 403) {
                console.warn("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω (403). –¢—Ä–µ–±—É–µ—Ç—Å—è Premium.");
                return response; 
            }
            if (!response.ok) {
                console.error(`–û—à–∏–±–∫–∞ API ${response.status}: ${response.statusText} –¥–ª—è URL ${url}`);
                throw new Error(`API Error: ${response.status}`);
            }
            return response;
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –≤–æ fetchProtected:", error);
            throw error;
        }
    }

    // ‚ñº‚ñº‚ñº –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ‚ñº‚ñº‚ñº
    async function fetchLevels() {
        try {
            const response = await fetchProtected("/api/levels");
            if (!response) return;
            
            const data = await response.json(); 
            state.levels = data.levels; 

            // --- ‚ñº‚ñº‚ñº –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê (–ü–£–ù–ö–¢ 1) ‚ñº‚ñº‚ñº ---
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            if (dom.statLessonsCompleted) {
                dom.statLessonsCompleted.textContent = `${data.completed_lessons}/${data.total_lessons}`;
            }
            
            if (dom.statTime) {
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∞—Å—ã (2.54321 -> 2.5—á)
                const hours = data.study_time_hours || 0;
                dom.statTime.textContent = `${hours.toFixed(1)}—á`;
            }

            // (–ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö)
            if (dom.statStars) dom.statStars.textContent = "0/0"; // TODO
            if (dom.statAccuracy) dom.statAccuracy.textContent = "0%"; // TODO
            // --- ‚ñ≤‚ñ≤‚ñ≤ –ö–û–ù–ï–¶ –ù–û–í–û–ô –õ–û–ì–ò–ö–ò ‚ñ≤‚ñ≤‚ñ≤ ---

            renderLevels(); // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–æ–ª—å–∫–æ —Å–ø–∏—Å–æ–∫ —É—Ä–æ–≤–Ω–µ–π
            
            if (state.levels.length > 0) {
                // –ê–≤—Ç–æ-–∫–ª–∏–∫ –ø–æ –ø–µ—Ä–≤–æ–º—É —É—Ä–æ–≤–Ω—é (A0)
                const firstLevel = state.levels.find(l => l.title === "A0") || state.levels[0];
                dom.levelsContainer.querySelector(`[data-id='${firstLevel.id}']`).click();
            }
        } catch (error) {
            console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —É—Ä–æ–≤–Ω–∏:", error);
        }
    }
    // ‚ñ≤‚ñ≤‚ñ≤ –ö–û–ù–ï–¶ –û–ë–ù–û–í–õ–ï–ù–ù–û–ô –§–£–ù–ö–¶–ò–ò ‚ñ≤‚ñ≤‚ñ≤


    async function fetchLessons(levelId) {
        if (isNaN(parseInt(levelId))) {
            console.error("–ù–µ–≤–µ—Ä–Ω—ã–π ID —É—Ä–æ–≤–Ω—è:", levelId);
            return;
        }
        try {
            const response = await fetchProtected(`/api/levels/${levelId}/lessons`);
            if (!response) return;
            state.lessons = await response.json();
            renderLessons();
        } catch (error) {
            console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —É—Ä–æ–∫–∏:", error);
        }
    }

    async function fetchSentences(lessonId) {
        if (isNaN(parseInt(lessonId))) {
            console.error("–ù–µ–≤–µ—Ä–Ω—ã–π ID —É—Ä–æ–∫–∞:", lessonId);
            return;
        }
        state.currentLessonId = lessonId;

        try {
            const response = await fetchProtected(`/api/lessons/${lessonId}/sentences`);
            if (!response) return;

            if (response.status === 403) {
                showPremiumModal();
                return;
            }

            state.sentences = await response.json();
            if (state.sentences.length === 0) {
                alert("–í —ç—Ç–æ–º —É—Ä–æ–∫–µ –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.");
                return;
            }

            const firstUnansweredIndex = state.sentences.findIndex(s => !(s.status?.Valid && s.status.String === 'mastered'));
            state.currentSentenceIndex = (firstUnansweredIndex === -1) ? 0 : firstUnansweredIndex;
            
            showView('trainer');
            loadSentence();

        } catch (error) {
            console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:", error);
        }
    }

    async function saveProgress(sentenceId, isCorrect) {
        try {
            await fetchProtected("/api/progress/save", {
                method: "POST",
                body: JSON.stringify({ sentence_id: sentenceId, is_correct: isCorrect })
            });
        } catch (error) {
            console.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å:", error);
        }
    }

    async function fetchErrorExplanation() {
        if (!state.sentences || state.currentSentenceIndex >= state.sentences.length) return;
        
        const sentence = state.sentences[state.currentSentenceIndex];
        const userAnswer = dom.userAnswer.value;

        if (userAnswer.trim() === "") {
            showAiExplanation("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π –æ—Ç–≤–µ—Ç, —á—Ç–æ–±—ã AI –º–æ–≥ –µ–≥–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å.");
            return;
        }

        showAiExplanation("ü§ñ –î—É–º–∞—é –Ω–∞–¥ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º...", 'loading');

        try {
            const response = await fetchProtected("/api/ai/explain-error", {
                method: "POST",
                body: JSON.stringify({
                    prompt_ru: sentence.prompt_ru,
                    correct_en: sentence.answer_en,
                    user_answer_en: userAnswer
                })
            });

            if (!response) return;
            const data = await response.json();

            if (data.error) {
                showAiExplanation(data.error, 'error');
            } else {
                showAiExplanation(data.explanation, 'success');
            }
        } catch (error) {
            console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ AI:", error);
            showAiExplanation("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å AI-–ø–æ–º–æ—â–Ω–∏–∫–æ–º.", 'error');
        }
    }

    // === 4. –§—É–Ω–∫—Ü–∏–∏ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ ===

    async function handleLogin(e) {
        e.preventDefault();
        const email = dom.authFormLogin.querySelector("#login-email").value;
        const password = dom.authFormLogin.querySelector("#login-password").value;
        
        try {
            const response = await fetch("/api/login", {
                method: "POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞");
            }

            saveToken(data.token, email);
            document.cookie = "auth_status=logged_in; path=/; max-age=" + 60*60*24*3; 
            initializeApp(); 

        } catch (error) {
            showAuthError(dom.authFormLogin, error.message);
        }
    }

    async function handleRegister(e) {
        e.preventDefault();
        const email = dom.authFormRegister.querySelector("#register-email").value;
        const password = dom.authFormRegister.querySelector("#register-password").value;
        
        if (password.length < 6) {
             showAuthError(dom.authFormRegister, "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤.");
             return;
        }

        try {
            const response = await fetch("/api/register", {
                method: "POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || "–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏");
            }
            
            alert("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.");
            showAuthForm('login');

        } catch (error) {
            showAuthError(dom.authFormRegister, error.message);
        }
    }

    function handleLogout() {
        localStorage.removeItem("token");
        localStorage.removeItem("userEmail");
        state.token = null;
        state.userEmail = null;
        
        document.cookie = "auth_status=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT";
        
        if (window.location.pathname.startsWith("/app")) {
            window.location.href = "/";
        } else {
            if (dom.header) dom.header.classList.add("hidden");
            showView('auth');
        }
    }

    function saveToken(token, email) {
        localStorage.setItem("token", token);
        localStorage.setItem("userEmail", email);
        state.token = token;
        state.userEmail = email;
    }

    function showAuthError(form, message) {
        const oldError = form.querySelector(".error-message");
        if (oldError) oldError.remove();

        const errorEl = document.createElement("p");
        errorEl.className = "error-message";
        errorEl.textContent = message;
        errorEl.style.color = "var(--error-color)";
        errorEl.style.textAlign = "center";
        
        form.prepend(errorEl);
    }

    function showAuthForm(formName) {
        if (formName === 'login') {
            dom.authFormLogin.classList.remove("hidden");
            dom.authFormRegister.classList.add("hidden");
        } else {
            dom.authFormLogin.classList.add("hidden");
            dom.authFormRegister.classList.remove("hidden");
        }
    }

    // === 5. –§—É–Ω–∫—Ü–∏–∏ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∏ UI ===

    function showView(viewName) {
        if (!viewName || !dom.views[viewName]) {
            viewName = 'dashboard';
        }
        state.currentView = viewName;
        
        Object.values(dom.views).forEach(view => view.classList.remove("active"));
        dom.views[viewName].classList.add("active");

        dom.navItems.forEach(item => {
            const isActive = item.dataset.view === viewName || (viewName === 'lessons' && item.dataset.view === 'dashboard');
            item.classList.toggle("active", isActive);
        });
        
        if (viewName === 'dashboard') {
            resetTrainer();
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ –¥—ç—à–±–æ—Ä–¥
            fetchLevels();
        }
    }

    function renderLevels() {
        dom.levelsContainer.innerHTML = "";
        state.levels.forEach(level => {
            const el = document.createElement("button");
            el.className = "level-item";
            el.textContent = level.title;
            el.dataset.id = level.id;
            el.textContent = getFullLevelName(level.title);
            dom.levelsContainer.appendChild(el);
        });
    }

    function getFullLevelName(title) {
        const names = {
            "A0": "A0 - Beginner",
            "A1": "A1 - Elementary",
            "A2": "A2 - Elementary",
            "B1": "B1 - Intermediate",
            "B2": "B2 - Upper-Intermediate",
            "C1": "C1 - Advanced",
        };
        return names[title] || title;
    }

    function renderLessons() {
        dom.lessonsContainer.innerHTML = "";
        if (!state.lessons || state.lessons.length === 0) {
            dom.lessonsContainer.innerHTML = "<p>–£—Ä–æ–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ —É—Ä–æ–≤–Ω—è —Å–∫–æ—Ä–æ –ø–æ—è–≤—è—Ç—Å—è!</p>";
            return;
        }

        const activeLevelEl = dom.levelsContainer.querySelector(".level-item.active");
        const activeLevelTitle = activeLevelEl ? activeLevelEl.textContent.split(" - ")[0] : "A1";
        
        dom.currentLevelTitle.textContent = `–£—Ä–æ–∫–∏ —É—Ä–æ–≤–Ω—è ${activeLevelTitle}`;
        
        let completedLessonsInLevel = 0;
        
        state.lessons.forEach(lesson => {
            const isLevelA0 = (activeLevelTitle === "A0");
            const isFirstFive = (lesson.lesson_number <= 5);
            const isFree = isLevelA0 || isFirstFive;
            const hasAccess = isFree || state.isPremium;

            const lessonCard = document.createElement("div");
            lessonCard.className = "lesson-card";
            lessonCard.dataset.id = lesson.id;
            lessonCard.dataset.title = lesson.title;

            if (!hasAccess) {
                lessonCard.classList.add("locked");
            }

            const total = lesson.total_sentences;
            const completed = lesson.completed_sentences;
            let progressPercent = 0;
            if (total > 0) {
                progressPercent = (completed / total) * 100;
            }
            
            if (progressPercent === 100) {
                completedLessonsInLevel++;
            }

            let button;
            if (!hasAccess) {
                button = `<button class="btn-orange" disabled>–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>`;
            } else if (progressPercent === 100) {
                button = `<button class="btn-secondary">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>`;
            } else if (progressPercent > 0) {
                button = `<button class="btn-primary">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>`;
            } else {
                button = `<button class="btn-primary">–ù–∞—á–∞—Ç—å</button>`;
            }

            let sentenceCountText = `${total} –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π`;
            if (total === 1) {
                sentenceCountText = `${total} –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ`;
            } else if (total > 1 && total < 5) {
                sentenceCountText = `${total} –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è`;
            }

            const stars = 0; // TODO: –õ–æ–≥–∏–∫–∞ –∑–≤–µ–∑–¥
            
            lessonCard.innerHTML = `
                <div class.lesson-card-header">
                    <h4>${lesson.title}</h4>
                    ${!hasAccess ? '<span class="pro-badge">PRO</span>' : `<span class="stars">${'‚≠ê'.repeat(stars)}${'‚òÜ'.repeat(3 - stars)}</span>`}
                </div>
                <p>${sentenceCountText} –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è</p>
                <div class="progress-bar">
                    <div class="progress-bar-inner" style="width: ${progressPercent}%;"></div>
                </div>
                <div class="card-actions">
                    ${button}
                </div>
            `;
            
            dom.lessonsContainer.appendChild(lessonCard);
        });
        
        dom.lessonProgressText.textContent = `${completedLessonsInLevel} –∏–∑ ${state.lessons.length} –∑–∞–≤–µ—Ä—à–µ–Ω–æ`;
    }

    function loadSentence() {
        if (!state.sentences || state.currentSentenceIndex >= state.sentences.length) {
             fetchLessons(state.lessons[0].level_id); // –û–±–Ω–æ–≤–ª—è–µ–º –¥—ç—à–±–æ—Ä–¥
             alert("–£—Ä–æ–∫ –ø—Ä–æ–π–¥–µ–Ω!");
             showView('dashboard');
             return;
        }
        
        const sentence = state.sentences[state.currentSentenceIndex];
        
        dom.promptRu.textContent = sentence.prompt_ru;
        dom.userAnswer.value = "";
        dom.userAnswer.disabled = false;
        
        dom.feedback.classList.add("hidden");
        dom.aiExplanation.classList.add("hidden");
        
        dom.checkAnswerBtn.classList.remove("hidden");
        dom.nextSentenceBtn.classList.add("hidden");

        const total = state.sentences.length;
        const current = state.currentSentenceIndex + 1;
        dom.progressText.textContent = `${current}/${total}`;
        dom.progressBarInner.style.width = `${(current / total) * 100}%`;
        
        dom.userAnswer.focus();
    }

    function resetTrainer() {
        state.currentLessonId = null;
        state.sentences = [];
        state.currentSentenceIndex = 0;
        if(dom.promptRu) dom.promptRu.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        if(dom.userAnswer) dom.userAnswer.value = "";
        if(dom.progressText) dom.progressText.textContent = "0/0";
        if(dom.progressBarInner) dom.progressBarInner.style.width = "0%";
        if(dom.feedback) dom.feedback.classList.add("hidden");
        if(dom.aiExplanation) dom.aiExplanation.classList.add("hidden");
    }

    function showFeedback(isCorrect, correctAnswer) {
        dom.feedback.classList.remove("hidden", "correct", "incorrect");
        if (isCorrect) {
            dom.feedback.classList.add("correct");
            dom.feedback.innerHTML = "<p><strong>–ü—Ä–∞–≤–∏–ª—å–Ω–æ! üëç</strong></p>";
        } else {
            dom.feedback.classList.add("incorrect");
            dom.feedback.innerHTML = `<p><strong>–û—à–∏–±–∫–∞ üòû</strong></p><p>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: <strong>${correctAnswer}</strong></p>`;
        }
    }

    function showAiExplanation(message, type = 'info') {
        dom.aiExplanation.classList.remove("hidden");
        dom.aiExplanation.innerHTML = `<p>${message}</p>`;
        if (type === 'loading') dom.aiExplanation.style.opacity = 0.7;
        else dom.aiExplanation.style.opacity = 1.0;
    }

    function showPremiumModal() {
        dom.premiumModalOverlay.classList.remove("hidden");
    }

    function hidePremiumModal() {
        dom.premiumModalOverlay.classList.add("hidden");
    }

    // === 6. –§—É–Ω–∫—Ü–∏–∏-–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ===

    function handleCheckAnswer() {
        const sentence = state.sentences[state.currentSentenceIndex];
        const userAnswer = dom.userAnswer.value.trim();
        const correctAnswer = sentence.answer_en.trim();
        const isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
        
        handlePlayAudio();
        showFeedback(isCorrect, correctAnswer);
        
        dom.userAnswer.disabled = true;
        dom.checkAnswerBtn.classList.add("hidden");
        dom.nextSentenceBtn.classList.remove("hidden");

        if (!isCorrect) {
            fetchErrorExplanation(); 
        } else {
            dom.aiExplanation.classList.add("hidden");
        }

        saveProgress(sentence.id, isCorrect);
        dom.nextSentenceBtn.focus();
    }

    function handleNextSentence() {
        state.currentSentenceIndex++;
        loadSentence();
    }

    function handlePlayAudio() {
        const sentence = state.sentences[state.currentSentenceIndex];
        if (!sentence) return;

        if (sentence.audio_path && sentence.audio_path.Valid) {
            const audio = new Audio(sentence.audio_path.String);
            audio.play().catch(e => {
                console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∞—É–¥–∏–æ—Ñ–∞–π–ª, –∏—Å–ø–æ–ª—å–∑—É–µ–º TTS:", e);
                playBrowserTTS(sentence.answer_en);
            });
        } else {
            playBrowserTTS(sentence.answer_en);
        }
    }
    
    function playBrowserTTS(text) {
        if (!text) return;
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = "en-US";
        window.speechSynthesis.speak(utterance);
    }
    
    function handleLevelClick(e) {
        const target = e.target.closest(".level-item");
        if (!target) return;
        dom.levelsContainer.querySelectorAll(".level-item").forEach(item => item.classList.remove("active"));
        target.classList.add("active");
        fetchLessons(target.dataset.id);
    }

    function handleLessonClick(e) {
        const target = e.target.closest(".lesson-card");
        if (!target) return;
        
        const btn = e.target.closest("button");
        if (btn) { 
            if (target.classList.contains("locked")) {
                showPremiumModal();
                return;
            }
            fetchSentences(target.dataset.id);
        }
    }

    function handleNavClick(e) {
        const target = e.target.closest(".nav-item");
        if (!target) return;
        
        const viewName = target.dataset.view;
        if (viewName === 'lessons') {
            showView('dashboard');
            dom.mainContent.scrollTo({ top: dom.levelsContainer.offsetTop, behavior: 'smooth' });
        } else {
            showView(viewName);
        }
    }


    // === 7. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===

    function initializeApp() {
        if (!dom.header) return; 
        
        dom.header.classList.remove("hidden");
        
        dom.userName.textContent = state.userEmail;
        dom.userAvatar.src = `https://ui-avatars.com/api/?name=${state.userEmail}&background=C026D3&color=fff`;
        
        fetchLevels(); // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ–ø–µ—Ä—å —Ç–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        showView('dashboard');
    }

    function main() {
        if (dom.dashboardView) {
            console.log("JS: –í–Ω—É—Ç—Ä–∏ /app. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...");

            // --- –ü—Ä–∏–≤—è–∑–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
            if(dom.logoutButton) dom.logoutButton.addEventListener("click", handleLogout);
            if(dom.navItems) dom.navItems.forEach(item => item.addEventListener("click", handleNavClick));
            if(dom.authFormLogin) dom.authFormLogin.addEventListener("submit", handleLogin);
            if(dom.authFormRegister) dom.authFormRegister.addEventListener("submit", handleRegister);
            if(dom.showRegisterBtn) dom.showRegisterBtn.addEventListener("click", (e) => { e.preventDefault(); showAuthForm('register'); });
            if(dom.showLoginBtn) dom.showLoginBtn.addEventListener("click", (e) => { e.preventDefault(); showAuthForm('login'); });
            if(dom.levelsContainer) dom.levelsContainer.addEventListener("click", handleLevelClick);
            if(dom.lessonsContainer) dom.lessonsContainer.addEventListener("click", handleLessonClick);
            if(dom.backToLessonsBtn) dom.backToLessonsBtn.addEventListener("click", () => showView('dashboard'));
            if(dom.checkAnswerBtn) dom.checkAnswerBtn.addEventListener("click", handleCheckAnswer);
            if(dom.nextSentenceBtn) dom.nextSentenceBtn.addEventListener("click", handleNextSentence);
            if(dom.playAudioBtn) dom.playAudioBtn.addEventListener("click", handlePlayAudio);
            
            if(dom.userAnswer) dom.userAnswer.addEventListener("keydown", (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!dom.checkAnswerBtn.classList.contains("hidden")) {
                        handleCheckAnswer();
                    }
                }
            });

            if(dom.premiumModalCloseBtn) dom.premiumModalCloseBtn.addEventListener("click", hidePremiumModal);
            if(dom.premiumModalOverlay) dom.premiumModalOverlay.addEventListener("click", (e) => {
                if (e.target === dom.premiumModalOverlay) hidePremiumModal();
            });

            // --- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–ó–∞–ª–æ–≥–∏–Ω–µ–Ω?) ---
            if (state.token) {
                initializeApp();
            } else {
                handleLogout(); // –ü–æ–∫–∞–∂–µ—Ç auth-view
            }
        }
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º!
    main();
});